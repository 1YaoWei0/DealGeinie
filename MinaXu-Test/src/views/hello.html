<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸Šä¼ ä¸å½•éŸ³</title>
    <!-- <link rel="stylesheet" href="../css/upload.css"> -->
    <script
      src="https://res.cdn.office.net/teams-js/2.22.0/js/MicrosoftTeams.min.js"
      integrity="sha384-WSG/sWulIv7rel5TnFlH8JTpxl2OxzZh9Lux2mIzBFiTRLFvMBeFv9VURu/3vQdx"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="/static/scripts/teamsapp.js"></script>
</head>
<body>
    <style>
        /* å…¨å±€æ ·å¼ */
body {
    font-family: Arial, sans-serif;
    background-color: #f9f9f9;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}

/* ä¸»å®¹å™¨ */
.container {
    width: 350px;
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

/* æ ‡é¢˜ */
h2 {
    font-size: 16px;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
}

/* å½•éŸ³åŒºåŸŸ */
.recording-box {
    background: #eef2ff;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    position: relative;
}

#timer {
    font-size: 18px;
    color: #333;
    margin-bottom: 10px;
}

#recordBtn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #4a90e2;
}

/* ä¸Šä¼ åŒºåŸŸ */
.upload-box {
    border: 2px dashed #4a90e2;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    background: #f0f8ff;
    margin-bottom: 10px;
}

.upload-box p {
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
}

.upload-box button {
    background: #4a90e2;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
}

.upload-box button:hover {
    background: #3578e5;
}

/* æ–‡ä»¶åˆ—è¡¨ */
#fileList {
    margin-top: 10px;
}

.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #eef2ff;
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 5px;
    font-size: 14px;
}

.file-item span {
    display: flex;
    align-items: center;
    gap: 8px;
}

.file-item button {
    background: none;
    border: none;
    cursor: pointer;
    color: #ff4d4f;
    font-size: 14px;
}

/* å½•éŸ³è¯†åˆ«çš„æ–‡æœ¬æ˜¾ç¤º */
#transcript {
    border: 1px solid #ccc;
    padding: 10px;
    min-height: 50px;
    font-size: 14px;
    margin-top: 10px;
    background: #f9f9f9;
    border-radius: 8px;
}

/* è¾“å…¥æ¡† */
#companyName {
    width: 330px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
    margin-top: 10px;
}

/* åˆ†ææŒ‰é’® */
#analyzeBtn {
    width: 100%;
    background: #4a90e2;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 8px;
    font-size: 16px;
    margin-top: 10px;
    cursor: pointer;
}

#analyzeBtn:hover {
    background: #3578e5;
}

#transFileScript {
    width: 330px;  /* è®©å®ƒé»˜è®¤é“ºæ»¡çˆ¶å®¹å™¨ */
    height: 50px;  /* å›ºå®šé«˜åº¦ */
    border: 1px solid #ccc;  /* æ·»åŠ è¾¹æ¡† */
    border-radius: 8px;  /* åœ†è§’ */
    padding: 10px;  /* å†…è¾¹è· */
    overflow: auto;  /* è®©å†…å®¹æ»šåŠ¨ï¼Œä¸æ’‘å¼€ */
    white-space: pre-wrap; /* ä¿æŒæ¢è¡Œ */
    background: #fff;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
}
    </style>
    <div class="container">
        <h2>æ–¹å¼1 - å½•éŸ³111</h2>
        <div class="recording-box">
            <p id="timer">00:00:00</p>
            <button id="recordBtn">â–¶</button>
            <p id="transcript"></p> <!-- æ˜¾ç¤ºè½¬æ¢çš„æ–‡æœ¬ä»Šå¤©æˆ‘ä¸ä¸Šæµ·æ™®ç»¿åŒ…è£…åˆ¶å“æœ‰é™å…¬å¸çš„é¡¾æ€»ã€å¼ºæ€»è¿›è¡Œäº†æ²Ÿé€šã€‚ä»–ä»¬ç›®å‰åœ¨è·Ÿè¿›ç³»ç»Ÿåˆ‡æ¢çš„éœ€æ±‚ï¼Œå¹¶æœ‰æ˜ç¡®çš„é¢„ç®—ã€‚æˆ‘ä»¬è®¨è®ºäº†ä¸šåŠ¡æµç¨‹è°ƒæ•´ã€ç‰©æ–™ç¼–ç è§„åˆ™å˜æ›´ä»¥åŠæ•°æ®æ•´ç†è®¡åˆ’ã€‚å®¢æˆ·è¡¨ç¤ºç†è§£ï¼Œå¹¶å·²ç»å®‰æ’äººå‘˜æµ‹è¯•æ•°æ®ã€‚æœ€ç»ˆå®¢æˆ·åŒæ„åœ¨12æœˆ6æ—¥å‰æä¾›ç¬¬ä¸€è½®æ•°æ®ï¼Œå¹¶ç¡®è®¤å¼€å‘éœ€æ±‚çš„å†»ç»“æ—¶é—´ã€‚æˆ‘ä»¬è®¡åˆ’ä¸‹å‘¨è¿›è¡Œç°åœºåŸ¹è®­ï¼Œå¹¶å¯¹æ•°æ®æ”¶é›†æ¨¡æ¿è¿›è¡Œè®²è§£ã€‚å¾…åŠäº‹é¡¹åŒ…æ‹¬ï¼šå®¢æˆ·éœ€è¦ç¡®è®¤ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£ï¼Œå¹¶å®‰æ’ç°åœºåŸ¹è®­ï¼ŒåŒæ—¶ç»§ç»­ä¸é“¶è¡Œæ²Ÿé€šé“¶ä¼ç›´è¿æ¥å£é—®é¢˜ã€‚å»ºè®®ä¸‹ä¸€æ­¥ç¡®ä¿ç°åœºåŸ¹è®­é¡ºåˆ©è¿›è¡Œï¼Œé‡ç‚¹è®²è§£æ•°æ®æ¨¡æ¿ï¼Œå¹¶è·Ÿè¿›å®¢æˆ·ç¡®è®¤ä¸šåŠ¡æ–‡æ¡£ï¼ŒåŒæ—¶æŒç»­å…³æ³¨é“¶ä¼ç›´è¿æ¥å£çš„è¿›å±•ã€‚ -->
        </div>
        
        <h2>æ–¹å¼2 - ä¸Šä¼ æ²Ÿé€šæ–‡ä»¶</h2>
        <div class="upload-box">
            <p>å¯ä¸Šä¼  DOCã€TXTã€MP3ã€MP4 åŠ PDF æ–‡ä»¶ï¼Œæœ€å¤šå¯ä¸Šä¼  3 ä¸ªæ–‡ä»¶</p>
            <input type="file" id="fileInput" multiple>
            <button id="uploadBtn">ä¸Šä¼ </button>
        </div>

        <div id="fileList"></div><!-- æ˜¾ç¤ºä¸Šä¼ çš„æ–‡ä»¶ -->
        <p id="transFileScript"></p> <!-- æ˜¾ç¤ºè½¬æ¢çš„æ–‡æœ¬ -->

        <input type="text" id="companyName" placeholder="è¯·è¾“å…¥å®¢æˆ·å…¬å¸åç§°">
        <button id="analyzeBtn">å¼€å§‹åˆ†æ</button>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let recognition;
        let timerInterval;
        let seconds = 0;

        const timerElement = document.getElementById("timer");
        const transcriptElement = document.getElementById("transcript");
        const transFileScriptElement = document.getElementById("transFileScript");

        const recordButton = document.getElementById("recordBtn");
      
      // å¯åŠ¨å½•éŸ³
async function startRecording() {
    // è·å–éº¦å…‹é£æƒé™
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    // å½•éŸ³æ•°æ®å¯ç”¨æ—¶å­˜å‚¨
    mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
    };

    // å½•éŸ³åœæ­¢æ—¶å¤„ç†éŸ³é¢‘
    mediaRecorder.onstop = () => {
        clearInterval(timerInterval); // åœæ­¢è®¡æ—¶
        seconds = 0;
        timerElement.textContent = "00:00:00"; // é‡ç½®è®¡æ—¶å™¨
    };

    mediaRecorder.start();
    startTimer();
    recordButton.textContent = "â– ";

    // å¯åŠ¨è¯­éŸ³è¯†åˆ«
    startSpeechRecognition();
}

// åœæ­¢å½•éŸ³
function stopRecording() {
    mediaRecorder.stop();
    recordButton.textContent = "â–¶";

    // ç»“æŸè¯­éŸ³è¯†åˆ«
    if (recognition) {
        recognition.stop();
    }
}

// è®¡æ—¶å™¨å‡½æ•°
function startTimer() {
    seconds = 0;
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        seconds++;
        let hrs = String(Math.floor(seconds / 3600)).padStart(2, "0");
        let mins = String(Math.floor((seconds % 3600) / 60)).padStart(2, "0");
        let secs = String(seconds % 60).padStart(2, "0");
        timerElement.textContent = `${hrs}:${mins}:${secs}`;
    }, 1000);
}

// è¯­éŸ³è¯†åˆ«å‡½æ•°
function startSpeechRecognition() {
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!window.SpeechRecognition) {
        transcriptElement.textContent = "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«";
        return;
    }

    recognition = new SpeechRecognition();
    recognition.continuous = true; // æŒç»­è¯†åˆ«
    recognition.interimResults = true; // æ˜¾ç¤ºå®æ—¶ç»“æœ
    recognition.lang = "zh-CN"; // è®¾ç½®è¯­è¨€

    recognition.onresult = (event) => {
        let transcript = "";
        for (let i = 0; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
        }
        transcriptElement.textContent = transcript; // å®æ—¶æ›´æ–°æ–‡æœ¬
    };

    recognition.start();
}

// ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
recordButton.addEventListener("click", () => {
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
        startRecording();
    } else {
        stopRecording();
    }
});

const fileInput = document.getElementById("fileInput");
const uploadButton = document.getElementById("uploadBtn");
const fileList = document.getElementById("fileList");

const MAX_FILES = 3;
let uploadedFiles = [];

// ç›‘å¬ä¸Šä¼ æŒ‰é’®
uploadButton.addEventListener("click", () => {
    const files = fileInput.files;
    if (files.length === 0) {
        alert("è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼");
        return;
    }

    if (uploadedFiles.length + files.length > MAX_FILES) {
        alert(`æœ€å¤šåªèƒ½ä¸Šä¼  ${MAX_FILES} ä¸ªæ–‡ä»¶`);
        return;
    }

    for (const file of files) {
        if (uploadedFiles.length >= MAX_FILES) break;
        // **æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ–‡ä»¶**
        if (uploadedFiles.some(uploadedFile => uploadedFile.name === file.name)) {
            alert(`æ–‡ä»¶ "${file.name}" å·²ç»ä¸Šä¼ è¿‡äº†ï¼`);
            continue;
        }
        
        uploadedFiles.push(file);  // ç¡®ä¿æ–‡ä»¶å­˜å…¥æ•°ç»„
        displayFile(file); // ç«‹å³æ›´æ–° UI
        processFile(file);
    }

    updateFileList();  // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
});
// æ˜¾ç¤ºå·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
function displayFile(file) {
    const fileItem = document.createElement("div");
    fileItem.classList.add("file-item");
    fileItem.innerHTML = `
        ğŸ“„ ${file.name} <button onclick="removeFile('${file.name}')">âŒ</button>
    `;
    fileList.appendChild(fileItem);
}

// ç§»é™¤æ–‡ä»¶
function removeFile(fileName) {
    uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
    updateFileList();
}

function updateFileList() {
    fileList.innerHTML = ""; // å…ˆæ¸…ç©º
    uploadedFiles.forEach(file => displayFile(file)); // é‡æ–°æ¸²æŸ“
}

// è§£ææ–‡ä»¶å†…å®¹
function processFile(file) {
    const reader = new FileReader();

    // å¤„ç†æ–‡æœ¬æ–‡ä»¶ï¼ˆTXTã€Wordï¼‰
    if (file.type.includes("text") || file.name.endsWith(".txt")) {
        reader.onload = () => {
            transFileScriptElement.textContent += `ğŸ“„ ${file.name} å†…å®¹:\n${reader.result}\n\n`;
        };
        reader.readAsText(file);
    }

    // å¤„ç† PDF æ–‡ä»¶
    else if (file.name.endsWith(".pdf")) {
        reader.onload = async () => {
            const pdfData = new Uint8Array(reader.result);
            const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
            let text = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(" ") + "\n";
            }
            transFileScriptElement.textContent += `ğŸ“„ ${file.name} å†…å®¹:\n${text}\n\n`;
        };
        reader.readAsArrayBuffer(file);
    }

    // å¤„ç† MP3/MP4 éŸ³è§†é¢‘æ–‡ä»¶ï¼ˆé›†æˆ Web Speech APIï¼‰
    else if (file.type.includes("audio") || file.type.includes("video")) {
        const url = URL.createObjectURL(file);
        const audio = new Audio(url);
        audio.play();

        const recognition = new webkitSpeechRecognition() || new SpeechRecognition();
        recognition.lang = "zh-CN";
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = (event) => {
            let transcript = "";
            for (let i = 0; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript;
            }
            transFileScriptElement.textContent += `ğŸ™ ${file.name} è½¬å†™:\n${transcript}\n\n`;
        };

        recognition.start();

        audio.onended = () => {
            recognition.stop();
            URL.revokeObjectURL(url);
        };
    }

    // å¤„ç†ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼
    else {
        transcriptElement.textContent += `âŒ ${file.name} æ— æ³•è§£æ\n\n`;
    }
}

document.getElementById("analyzeBtn").addEventListener("click", async () => {
    const companyName = document.getElementById("companyName").value;
    if (!companyName) {
        alert("è¯·è¾“å…¥å®¢æˆ·å…¬å¸åç§°ï¼");
        return;
    }

    // è·å–ä¸Šä¼ æ–¹å¼
    const uploadMethod = uploadedFiles.length > 0 ? "æ–‡ä»¶ä¸Šä¼ " : "å½•éŸ³";
    localStorage.setItem("uploadMethod", uploadMethod);
    localStorage.setItem("transcriptElement", transcriptElement.textContent);
    
    // å­˜å‚¨å·²ä¸Šä¼ çš„æ–‡ä»¶
    const fileNames = uploadedFiles.map(file => file.name);
    localStorage.setItem("uploadedFiles", JSON.stringify(fileNames));

    // è·³è½¬åˆ°åˆ†æç»“æœç•Œé¢
    window.location.href = "adssa.html";
});
  </script>
</body>
</html>

