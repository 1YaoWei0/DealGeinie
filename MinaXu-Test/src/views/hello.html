<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸Šä¼ ä¸å½•éŸ³</title>
    <link rel="stylesheet" href="../css/upload.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>æ–¹å¼1 - å½•éŸ³</h2>
        <div class="recording-box">
            <p id="timer">00:00:00</p>
            <button id="recordBtn">â–¶</button>
            <p id="transcript"></p> <!-- æ˜¾ç¤ºè½¬æ¢çš„æ–‡æœ¬ -->
        </div>
        
        <h2>æ–¹å¼2 - ä¸Šä¼ æ²Ÿé€šæ–‡ä»¶</h2>
        <div class="upload-box">
            <p>å¯ä¸Šä¼  Wordã€TXTã€MP3ã€MP4 åŠ PDF æ–‡ä»¶ï¼Œæœ€å¤šå¯ä¸Šä¼  3 ä¸ªæ–‡ä»¶</p>
            <input type="file" id="fileInput" multiple>
            <button id="uploadBtn">ä¸Šä¼ </button>
        </div>

        
        <div id="fileList"></div><!-- æ˜¾ç¤ºä¸Šä¼ çš„æ–‡ä»¶ -->
        <p id="transFileScript"></p> <!-- æ˜¾ç¤ºè½¬æ¢çš„æ–‡æœ¬ -->

        <input type="text" id="companyName" placeholder="è¯·è¾“å…¥å®¢æˆ·å…¬å¸åç§°">
        <button id="analyzeBtn">å¼€å§‹åˆ†æ</button>
    </div>

    <script>
              let mediaRecorder;
    let audioChunks = [];
let recognition;
let timerInterval;
let seconds = 0;

const timerElement = document.getElementById("timer");
const transcriptElement = document.getElementById("transcript");
const transFileScriptElement = document.getElementById("transFileScript");

const recordButton = document.getElementById("recordBtn");
      
      // å¯åŠ¨å½•éŸ³
async function startRecording() {
    // è·å–éº¦å…‹é£æƒé™
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    // å½•éŸ³æ•°æ®å¯ç”¨æ—¶å­˜å‚¨
    mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
    };

    // å½•éŸ³åœæ­¢æ—¶å¤„ç†éŸ³é¢‘
    mediaRecorder.onstop = () => {
        clearInterval(timerInterval); // åœæ­¢è®¡æ—¶
        seconds = 0;
        timerElement.textContent = "00:00:00"; // é‡ç½®è®¡æ—¶å™¨
    };

    mediaRecorder.start();
    startTimer();
    recordButton.textContent = "â– ";

    // å¯åŠ¨è¯­éŸ³è¯†åˆ«
    startSpeechRecognition();
}

// åœæ­¢å½•éŸ³
function stopRecording() {
    mediaRecorder.stop();
    recordButton.textContent = "â–¶";

    // ç»“æŸè¯­éŸ³è¯†åˆ«
    if (recognition) {
        recognition.stop();
    }
}

// è®¡æ—¶å™¨å‡½æ•°
function startTimer() {
    seconds = 0;
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        seconds++;
        let hrs = String(Math.floor(seconds / 3600)).padStart(2, "0");
        let mins = String(Math.floor((seconds % 3600) / 60)).padStart(2, "0");
        let secs = String(seconds % 60).padStart(2, "0");
        timerElement.textContent = `${hrs}:${mins}:${secs}`;
    }, 1000);
}

// è¯­éŸ³è¯†åˆ«å‡½æ•°
function startSpeechRecognition() {
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!window.SpeechRecognition) {
        transcriptElement.textContent = "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«";
        return;
    }

    recognition = new SpeechRecognition();
    recognition.continuous = true; // æŒç»­è¯†åˆ«
    recognition.interimResults = true; // æ˜¾ç¤ºå®æ—¶ç»“æœ
    recognition.lang = "zh-CN"; // è®¾ç½®è¯­è¨€

    recognition.onresult = (event) => {
        let transcript = "";
        for (let i = 0; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
        }
        transcriptElement.textContent = transcript; // å®æ—¶æ›´æ–°æ–‡æœ¬
    };

    recognition.start();
}

// ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
recordButton.addEventListener("click", () => {
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
        startRecording();
    } else {
        stopRecording();
    }
});

const fileInput = document.getElementById("fileInput");
const uploadButton = document.getElementById("uploadBtn");
const fileList = document.getElementById("fileList");

const MAX_FILES = 3;
let uploadedFiles = [];

// ç›‘å¬ä¸Šä¼ æŒ‰é’®
uploadButton.addEventListener("click", () => {
    const files = fileInput.files;
    if (files.length === 0) {
        alert("è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼");
        return;
    }

    if (uploadedFiles.length + files.length > MAX_FILES) {
        alert(`æœ€å¤šåªèƒ½ä¸Šä¼  ${MAX_FILES} ä¸ªæ–‡ä»¶`);
        return;
    }

    for (const file of files) {
        if (uploadedFiles.length >= MAX_FILES) break;
        // **æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ–‡ä»¶**
        if (uploadedFiles.some(uploadedFile => uploadedFile.name === file.name)) {
            alert(`æ–‡ä»¶ "${file.name}" å·²ç»ä¸Šä¼ è¿‡äº†ï¼`);
            continue;
        }
        
        uploadedFiles.push(file);  // ç¡®ä¿æ–‡ä»¶å­˜å…¥æ•°ç»„
        displayFile(file); // ç«‹å³æ›´æ–° UI
        processFile(file);
    }

    updateFileList();  // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
});
// æ˜¾ç¤ºå·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
function displayFile(file) {
    const fileItem = document.createElement("div");
    fileItem.classList.add("file-item");
    fileItem.innerHTML = `
        ğŸ“„ ${file.name} <button onclick="removeFile('${file.name}')">âŒ</button>
    `;
    fileList.appendChild(fileItem);
}

// ç§»é™¤æ–‡ä»¶
function removeFile(fileName) {
    uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
    updateFileList();
}

function updateFileList() {
    fileList.innerHTML = ""; // å…ˆæ¸…ç©º
    uploadedFiles.forEach(file => displayFile(file)); // é‡æ–°æ¸²æŸ“
}

// è§£ææ–‡ä»¶å†…å®¹
function processFile(file) {
    const reader = new FileReader();

    // å¤„ç†æ–‡æœ¬æ–‡ä»¶ï¼ˆTXTã€Wordï¼‰
    if (file.type.includes("text") || file.name.endsWith(".txt")) {
        reader.onload = () => {
            transFileScriptElement.textContent += `ğŸ“„ ${file.name} å†…å®¹:\n${reader.result}\n\n`;
        };
        reader.readAsText(file);
    }

    // å¤„ç† PDF æ–‡ä»¶
    else if (file.name.endsWith(".pdf")) {
        reader.onload = async () => {
            const pdfData = new Uint8Array(reader.result);
            const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
            let text = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(" ") + "\n";
            }
            transFileScriptElement.textContent += `ğŸ“„ ${file.name} å†…å®¹:\n${text}\n\n`;
        };
        reader.readAsArrayBuffer(file);
    }

    // å¤„ç† MP3/MP4 éŸ³è§†é¢‘æ–‡ä»¶ï¼ˆé›†æˆ Web Speech APIï¼‰
    else if (file.type.includes("audio") || file.type.includes("video")) {
        const url = URL.createObjectURL(file);
        const audio = new Audio(url);
        audio.play();

        const recognition = new webkitSpeechRecognition() || new SpeechRecognition();
        recognition.lang = "zh-CN";
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = (event) => {
            let transcript = "";
            for (let i = 0; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript;
            }
            transFileScriptElement.textContent += `ğŸ™ ${file.name} è½¬å†™:\n${transcript}\n\n`;
        };

        recognition.start();

        audio.onended = () => {
            recognition.stop();
            URL.revokeObjectURL(url);
        };
    }

    // å¤„ç†ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼
    else {
        transcriptElement.textContent += `âŒ ${file.name} æ— æ³•è§£æ\n\n`;
    }
}

document.getElementById("analyzeBtn").addEventListener("click", async () => {
    const companyName = document.getElementById("companyName").value;
    if (!companyName) {
        alert("è¯·è¾“å…¥å®¢æˆ·å…¬å¸åç§°ï¼");
        return;
    }

    // è·å–ä¸Šä¼ æ–¹å¼
    const uploadMethod = uploadedFiles.length > 0 ? "æ–‡ä»¶ä¸Šä¼ " : "å½•éŸ³";
    localStorage.setItem("uploadMethod", uploadMethod);

    // å­˜å‚¨å·²ä¸Šä¼ çš„æ–‡ä»¶
    const fileNames = uploadedFiles.map(file => file.name);
    localStorage.setItem("uploadedFiles", JSON.stringify(fileNames));

    // å‡è®¾è°ƒç”¨å¤§æ¨¡å‹ API è·å–åˆ†æç»“æœ
    const analysisResult = `
        å…¬å¸åç§°:${companyName}
        å®¢æˆ·åç§°:é¢œæ€»ã€å¼ºæ€»ã€Jasonã€Jocke
        è·Ÿè¿›çŠ¶æ€:è·Ÿè¿›ä¸­æœ‰éœ€æ±‚æœ‰é¢„ç®—
        è¿›å±•æ€»ç»“:æœ¬æ¬¡æ²Ÿé€šä¸»è¦å›´ç»•ä¸šåŠ¡æµç¨‹è°ƒæ•´ã€ç‰©æ–™ç¼–ç è§„åˆ™å˜æ›´ã€å¼€å‘éœ€æ±‚å˜æ›´ä»¥åŠæ¬¾é¡¹ç®¡ç†è®¡åˆ’å±•å¼€...
    `;
    localStorage.setItem("analysisResult", analysisResult);

    // è·³è½¬åˆ°åˆ†æç»“æœç•Œé¢
    window.location.href = "gpt.html";
});
  </script>
</body>
</html>

