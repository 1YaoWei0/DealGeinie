<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastGPT 大模型调用</title>
    <script src="../js/jpt.js"></script>
</head>
<body>
    
    <h1>分析结果</h1>
    <input type="text" id="userInput" placeholder="输入你的问题">
    <button onclick="sendMessage()">发送</button>
    
    <p><strong>回复：</strong> <span id="response"></span></p>
    
    <button id="syncButton">同步</button>，

    <style>
        #syncButton {
          background-color: #007bff; /* 蓝色背景 */
          color: white; /* 白色字体 */
          font-size: 16px; /* 字体大小 */
          padding: 10px 20px; /* 内边距，使按钮看起来更大 */
          border-radius: 25px; /* 圆角 */
          border: none; /* 去掉默认的边框 */
          cursor: pointer; /* 鼠标悬停时显示手指图标 */
          transition: background-color 0.3s ease; /* 平滑的背景色过渡 */
        }
      
        /* 鼠标悬停时改变背景色 */
        #syncButton:hover {
          background-color: #0056b3; /* 悬停时变为深蓝色 */
        }
      
        /* 点击按钮时的效果 */
        #syncButton:active {
          background-color: #003f7f; /* 点击时变为更深的蓝色 */
        }
      
        /* 按钮在不同屏幕下自适应 */
        @media (max-width: 600px) {
          #syncButton {
            width: 100%; /* 小屏幕时让按钮占满整个宽度 */
          }
        }
      </style>
      
<script>

// 今天我与上海普嫌包装制品有限公司的顾总、强总进行了沟通。他们目前在跟进系统切换的需求，并有明确的预算。我们讨论了业务流程调整、物料编码规则变更以及数据整理计划。客户表示理解，并已经安排人员测试数据。最终客户同意在12月6日前提供第一轮数据，并确认开发需求的冻结时间。我们计划下周进行现场培训，并对数据收集模板进行讲解。待办事项包括：客户需要确认业务需求文档，并安排现场培训，同时继续与银行沟通银企直连接口问题。建议下一步确保现场培训顺利进行，重点讲解数据模板，并跟进客户确认业务文档，同时持续关注银企直连接口的进展。
    async function sendMessage() {
        const input = document.getElementById("userInput").value;

        if (!input.trim()) {
            alert("请输入问题！");
            return;
        }

        document.getElementById("response").textContent = "正在生成回复...";

        try {
            const reply = await callFastGPT(input);
            console.log("reply:", reply);
            document.getElementById("response").textContent = reply || "未获取到回复";
        } catch (error) {
            console.error("❌ 发生错误:", error);
            document.getElementById("response").textContent = "请求失败，请检查控制台";
        }
    }

    async function callFastGPT(prompt) {
    const apiKey = "huamei-ERTaZXvYuDQesusqaw2WGexoRwAy0GLPpscVS2YqOLFIk2r3UXSfo"; // 你的 FastGPT API Key
    const apiUrl = "https://ai.huameisoft.cn/api/v1/chat/completions";

    const requestBody = {
        chatId: "my_chatId",
        stream: false,
        detail: false,
        responseChatItemId: "my_responseChatItemId",
        variables: {
            uid: "asdfadsfasfd2323",
            name: "张三"
        },
        messages: [
            {
                role: "user",
                content: `请基于我的输入内容【${prompt}】进行解析，并返回符合下述 JSON 结构的内容请仅返回 **纯 JSON**，不要包含 Markdown 代码块（如 \`\`\`json ）。只返回一个json json
                        {
                        "公司名称": "公司名称",
                        "客户名称": "客户联系人，多人用逗号隔开",
                        "跟进状态": "当前状态",
                        "进展总结": "沟通摘要",--
                        "结论总结": "结论总结",
                        "待办总结": "待办事项",
                        "下一步沟通建议": [
                        "建议1",
                        "建议2",
                        "建议3"
                        ]
                        }` // 传入的 prompt 替换 content
            }
        ]
    };

    try {
        const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`请求失败: ${response.statusText}`);
        }

        const data = await response.json();
        console.log("FastGPT 回复:", data);

        // 提取 "content" 值
        // const content = data.choices[0].message.content;

        const content = '{"公司名称": "上海普嫌包装制品有限公司","客户名称": "顾总, 强总","跟进状态": "跟进中有需求有预算","进展总结": "讨论了业务流程调整、物料编码规则变更以及数据整理计划，客户已安排人员测试数据。","结论总结": "客户同意在12月6日前提供第一轮数据，并确认开发需求的冻结时间。","待办总结": "客户需要确认业务需求文档，安排现场培训，并继续与银行沟通银企直连接口问题。","下一步沟通建议": ["确保现场培训顺利进行","重点讲解数据模板","跟进客户确认业务文档，并持续关注银企直连接口的进展"]}'
                
        const jsonData = JSON.parse(content);

        // 存储 jsonData 到 localStorage
        localStorage.setItem("jsonData", JSON.stringify(jsonData));

    // 访问 JSON 数据
    console.log("公司名称:", jsonData["公司名称"]);
    console.log("客户名称:", jsonData["客户名称"]);
    console.log("跟进状态:", jsonData["跟进状态"]);
    console.log("进展总结:", jsonData["进展总结"]);
    console.log("结论总结:", jsonData["结论总结"]);
    console.log("待办总结:", jsonData["待办总结"]);
    console.log("下一步沟通建议:", jsonData["下一步沟通建议"].join("；"));
        return content;

    } catch (error) {
        console.error("❌ FastGPT 请求失败:", error);
        return "请求失败";
    }    
}

// 请基于我的输入内容【今天我与上海普嫌包装制品有限公司的顾总、强总进行了沟通。他们目前在跟进系统切换的需求，并有明确的预算。我们讨论了业务流程调整、物料编码规则变更以及数据整理计划。客户表示理解，并已经安排人员测试数据。最终客户同意在12月6日前提供第一轮数据，并确认开发需求的冻结时间。我们计划下周进行现场培训，并对数据收集模板进行讲解。待办事项包括：客户需要确认业务需求文档，并安排现场培训，同时继续与银行沟通银企直连接口问题。建议下一步确保现场培训顺利进行，重点讲解数据模板，并跟进客户确认业务文档，同时持续关注银企直连接口的进展。】进行解析，并返回符合上述 JSON 结构的内容。
// json
// {
// "公司名称": "公司名称",
// "客户名称": "客户联系人，多人用逗号隔开",
// "跟进状态": "当前状态",
// "进展总结": "沟通摘要",--
// "结论总结": "结论总结",
// "待办总结": "待办事项",
// "下一步沟通建议": [
// "建议1",
// "建议2",
// "建议3"
// ]
// }

// 点击 "同步" 按钮时的操作
document.getElementById("syncButton").onclick = function() {
    // 获取存储的 jsonData
    const jsonData = JSON.parse(localStorage.getItem("jsonData"));
    // 将 jsonData 序列化为 URL 参数并跳转到接收界面
    const encodedJsonData = encodeURIComponent(JSON.stringify(jsonData));
    window.location.href = `sync_to_crm.html?jsonData=${encodedJsonData}`;
};
</script>

</body>
</html>